import{bc as S,be as T,r as P,bg as w,bd as p,aA as j,bf as C,aO as k,g as O,p as L,e as R,O as B,a as D,n as J,q as N,S as E,t as U,b as f,C as $,bh as F,az as G,Y as I,a1 as b,Z as V,a3 as M,a4 as i,a0 as z,$ as g,a7 as l,F as A,a6 as H,a9 as _,j as h,V as m,bi as W,bj as q,bk as K}from"./index-60NmDgdv.js";import{g as Y}from"./utils-sG5MXUTE.js";import{T as v}from"./index-Bsd8uZGG.js";function pe(e){return Object.keys(e?.properties??{}).find(s=>e?.properties[s].format==="bounding-box")}function Z(e){return Object.keys(e?.properties??{}).filter(s=>e?.properties[s].type==="geojson")}function ye(e,s){const a=Z(s);for(const t of a)e[t]&&(Y(s?.properties[t])?e[t]=e[t].features.map(o=>JSON.stringify(o.geometry)):e[t]=JSON.stringify(e[t].geometry))}async function Q(e,s,a,t,o){let r=null;"eox:flatstyle"in(e??{})&&(r=await S.get(e["eox:flatstyle"]).then(c=>c.data));let d,n;if(r){const c=T(s??"",r);d=c.layerConfig,n=c.style}a=a.sort();const u=a.length>0?{type:"WebGLTile",source:{type:"GeoTIFF",normalize:!n,sources:a.map(c=>({url:c}))},properties:{id:s+"_geotiff_process"+o,title:"Results "+s,...d&&{layerConfig:d},layerControlToolsExpand:!0},...n&&{style:n}}:void 0;return t&&u&&(u.source.projection=t),u}const X=(e,s)=>{if(!s)return;let a=s;if(typeof s=="object"){s=JSON.stringify(s);const o=new Blob([s],{type:"text"});a=URL.createObjectURL(o)}const t=document.createElement("a");confirm(`Would you like to download ${e}?`)&&(t.href=a,t.download=e,t.click()),URL.revokeObjectURL(a),t.remove()},y=P([]);async function ge({processUrl:e,isPolling:s,pollInterval:a=1e4,maxRetries:t=560}){let o=0;for(s.value=!0,setTimeout(()=>{x(y,p)},500);o<t&&s.value;){try{const r=new Date().getTime(),n=(await w.get(`${e}?t=${r}`)).data;if(n.status==="successful"){console.log("Process completed successfully. Fetching result item...");const u=n.links[1].href;if(!u)throw new Error("Result links not found in the process report.");const c=await w.get(u);return console.log("Result file fetched successfully:",c.data),c.data}if(n.status==="failed")throw s.value=!1,new Error("Process failed.",n);console.log(`Status: ${n.status}. Retrying in ${a/1e3} seconds...`)}catch(r){r instanceof Error?console.error("Error while polling process status:",r.message):console.error("Unknown error occurred:",r)}await new Promise(r=>setTimeout(r,a)),o++}if(!s.value)return console.warn("Polling was stopped before the process was completed."),JSON.parse("{}");throw new Error("Max retries reached. Process did not complete successfully.")}async function x(e,s){const a=JSON.parse(localStorage.getItem(s.value)||"[]"),t=await Promise.all(a.map(o=>fetch(o).then(r=>r.json())));t.sort((o,r)=>new Date(r.job_start_datetime).getTime()-new Date(o.job_start_datetime).getTime()),e.value=t}const ee=async e=>{const a=JSON.parse(localStorage.getItem(p.value)||"[]").filter(t=>!t.includes(e.jobID));localStorage.setItem(p.value,JSON.stringify(a)),x(y,p)},te=async(e,s)=>{const a=[];await fetch(e.links[1].href).then(t=>t.json()).then(t=>{a.push(...t.urls)}),a.forEach(t=>{if(!t)return;let o="";typeof t=="string"?(o=t.includes("/")?t.split("/").pop()??"":t,o=o.includes("?")?o.split("?")[0]:o):o=s?.id+"_process_results.json",X(o,t)})},se=async(e,s)=>{const a=[];await w.get(e.links[1].href).then(t=>a.push(t.data)),await oe({selectedStac:s,results:a,jobId:e.jobID})};async function oe({selectedStac:e,results:s,jobId:a}){const t=e?.links.filter(r=>r.rel==="service"&&r.type==="image/tiff"),o=await Q(t?.[0],e?.id??"",s?.[0].urls,e?.["eodash:mapProjection"]?.name??null,a);if(j.debug("rendered layers after loading previous process:",o),o){const r=[...o?[o]:[]];let d=[...C()];d.find(u=>u.properties.id.includes("AnalysisGroup"))?.layers.push(...r),k.value&&(k.value.layers=[...d])}}const ae=L({fixedHeader:Boolean,fixedFooter:Boolean,height:[Number,String],hover:Boolean,...U(),...E(),...N(),...J()},"VTable"),re=O()({name:"VTable",props:ae(),setup(e,s){let{slots:a,emit:t}=s;const{themeClasses:o}=R(e),{densityClasses:r}=B(e);return D(()=>f(e.tag,{class:["v-table",{"v-table--fixed-height":!!e.height,"v-table--fixed-header":e.fixedHeader,"v-table--fixed-footer":e.fixedFooter,"v-table--has-top":!!a.top,"v-table--has-bottom":!!a.bottom,"v-table--hover":e.hover},o.value,r.value,e.class],style:e.style},{default:()=>[a.top?.(),a.default?f("div",{class:"v-table__wrapper",style:{height:$(e.height)}},[f("table",null,[a.default()])]):a.wrapper?.(),a.bottom?.()]})),{}}}),le={style:{padding:"0px"}},ne={style:{padding:"0px"}},ie={style:{padding:"0px"}},ce={__name:"ProcessList",setup(e){const{selectedStac:s}=F(G());return I(()=>x(y,p)),(a,t)=>(g(),b("div",null,[i(y).length?(g(),V(re,{key:0,density:"compact",style:{"background-color":"transparent"}},{default:z(()=>[t[0]||(t[0]=l("thead",null,[l("tr",null,[l("th",{class:"text-left"},"Executed on"),l("th",{class:"text-left"},"Status"),l("th",{class:"text-left"}),l("th",{class:"text-left"}),l("th",{class:"text-left"})])],-1)),l("tbody",null,[(g(!0),b(A,null,H(i(y),o=>(g(),b("tr",{key:o.date},[l("td",null,_(new Date(o.job_start_datetime).toISOString().slice(0,16)),1),l("td",null,_(o.status),1),l("td",le,[h(f(m,{disabled:o.status!=="successful",color:"primary",onClick:r=>i(se)(o,i(s)),icon:[i(W)],variant:"text"},null,8,["disabled","onClick","icon"]),[[v,"Load results to map"]])]),l("td",ne,[h(f(m,{disabled:o.status!=="successful",color:"primary",onClick:r=>i(te)(o,i(s)),icon:[i(q)],variant:"text"},null,8,["disabled","onClick","icon"]),[[v,"Download results"]])]),l("td",ie,[h(f(m,{color:"#ff5252",onClick:r=>i(ee)(o),icon:[i(K)],variant:"text"},null,8,["onClick","icon"]),[[v,"Remove job"]])])]))),128))])]),_:1})):M("v-if",!0)]))}},be=Object.freeze(Object.defineProperty({__proto__:null,default:ce},Symbol.toStringTag,{value:"Module"}));export{be as P,ce as _,Q as c,X as d,ye as e,pe as g,y as j,ge as p,x as u};
